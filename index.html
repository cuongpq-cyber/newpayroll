<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính Lương NET (Form Magenest)</title>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .input-group label { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; display: block; }
        .input-group input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.95rem; transition: border-color 0.2s; }
        .input-group input:focus { outline: none; border-color: #2563eb; ring: 2px solid #2563eb; }
        .receipt-row { display: flex; justify-content: space-between; padding-top: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed #e5e7eb; }
        .receipt-row:last-child { border-bottom: none; }
        .receipt-label { color: #6b7280; font-size: 0.9rem; }
        .receipt-value { font-weight: 600; color: #111827; }
        .tag-tax-exempt { font-size: 0.7rem; background-color: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 4px; margin-left: 4px; }
        .tag-taxable { font-size: 0.7rem; background-color: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; margin-left: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const formatCurrency = (amount) => {
            if (isNaN(amount) || amount === null) return "0 ₫";
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        };

        const App = () => {
            // Default State: All fields set to 0 or empty string!
            const [data, setData] = useState({
                baseSalary: "",
                qualityBonus: "",
                lunchAllowance: "",
                rate: "",
                workDays: "",
                hoursPerDay: "",
                otHours15: "",
                otHours20: "",
                projBonus: "",
                lateMin: "",
                insuranceBase: "",
                insuranceRate: "",
                personalDeduction: ""
            });

            const [results, setResults] = useState({});
            const [isScanning, setIsScanning] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                // Safely parse numbers, fall back to 0 if empty or invalid
                const num = (v) => {
                    const n = parseFloat(v); return (!v || isNaN(n)) ? 0 : n;
                };

                // 1. Calculate Earnings
                const ratio = num(data.workDays) === 0 ? 0 : num(data.rate) / num(data.workDays);

                const actualBaseSalary = num(data.baseSalary) * ratio;
                const actualQualityBonus = num(data.qualityBonus) * ratio;
                const actualLunch = num(data.lunchAllowance) * ratio;

                // Hourly Rate for OT (Based on Base Salary usually)
                const hourlyRate = (num(data.baseSalary) && num(data.workDays) && num(data.hoursPerDay))
                    ? num(data.baseSalary) / (num(data.workDays) * num(data.hoursPerDay)) : 0;
                const otSalary15 = num(data.otHours15) * 1.5 * hourlyRate;
                const otSalary20 = num(data.otHours20) * 2.0 * hourlyRate;
                const totalOtSalary = otSalary15 + otSalary20;

                // Deductions
                const latePenalty = num(data.lateMin) * 1000;
                const insuranceDeduction = num(data.insuranceBase) * (num(data.insuranceRate) / 100);

                // Taxable income calculation
                const totalIncome = actualBaseSalary + actualQualityBonus + actualLunch + totalOtSalary + num(data.projBonus);
                const taxableIncome = totalIncome - actualLunch;
                const taxDeductions = num(data.personalDeduction) + insuranceDeduction;
                let taxAssessmentIncome = taxableIncome - taxDeductions;
                if (taxAssessmentIncome < 0) taxAssessmentIncome = 0;

                // PIT calculation (same as old)
                let tax = 0;
                if (taxAssessmentIncome <= 5000000) tax = taxAssessmentIncome * 0.05;
                else if (taxAssessmentIncome <= 10000000) tax = 250000 + (taxAssessmentIncome - 5000000) * 0.10;
                else if (taxAssessmentIncome <= 18000000) tax = 750000 + (taxAssessmentIncome - 10000000) * 0.15;
                else if (taxAssessmentIncome <= 32000000) tax = 1950000 + (taxAssessmentIncome - 18000000) * 0.20;
                else tax = 4750000 + (taxAssessmentIncome - 32000000) * 0.25;

                const netIncome = totalIncome - insuranceDeduction - latePenalty - tax;

                setResults({
                    hourlyRate,
                    actualBaseSalary,
                    actualQualityBonus,
                    actualLunch,
                    otSalary15,
                    otSalary20,
                    totalOtSalary,
                    insuranceDeduction,
                    taxableIncome,
                    taxAssessmentIncome,
                    taxDeductions,
                    tax,
                    latePenalty,
                    netIncome
                });
            }, [data]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setData(prev => ({
                    ...prev,
                    [name]: value // allow empty string!
                }));
            };

            const loadStandardData = () => {
                // Reset: all to "" except hoursPerDay default 8
                setData({
                    baseSalary: "",
                    qualityBonus: "",
                    lunchAllowance: "",
                    rate: "",
                    workDays: "",
                    hoursPerDay: "8",
                    otHours15: "",
                    otHours20: "",
                    projBonus: "",
                    lateMin: "",
                    insuranceBase: "",
                    insuranceRate: "",
                    personalDeduction: ""
                });
            };

            /**
             * Smart OCR for Magenest's timekeeping screenshot (image #1)
             *
             * - Reads expected field values: rate, workDays, lateMin, otHours15, otHours20, etc.
             * - Focus: robustly extract numbers on the provided image type.
             */
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setIsScanning(true);

                try {
                    const worker = await Tesseract.createWorker("eng", 1, {
                        logger: m => console.log(m)
                    });

                    const ret = await worker.recognize(file);
                    const text = ret.data.text;
                    console.log("OCR Result:", text);

                    // --- SMART LOGIC TO READ YOUR TIMEKEEPING IMAGE #1 ---
                    // For robustness, each field will be searched with several fallback patterns

                    // Rate (example: "14.6/ 23")
                    let rate = "";
                    let workDays = "";
                    const rateRegex = /Rate\s*([0-9.,]+)\s*\/\s*([0-9.,]+)/i;
                    const rateMatch = text.match(rateRegex);
                    if (rateMatch) {
                        rate = rateMatch[1].replace(",", "."); // take left value
                        workDays = rateMatch[2].replace(",", ".");
                    } else {
                        // Fallback pattern
                        const rateFallback = text.match(/([0-9]+(\.[0-9]+)?)\s*\/\s*([0-9]+(\.[0-9]+)?)/);
                        if (rateFallback) {
                            rate = rateFallback[1];
                            workDays = rateFallback[3];
                        }
                    }

                    // Late minutes (e.g. "Late Total(min): 169.0")
                    let lateMin = "";
                    const lateMinRegex = /Late\s*Total.*?([0-9]+(\.[0-9]+)?)/i;
                    const lateMinMatch = text.match(lateMinRegex);
                    if (lateMinMatch) {
                        lateMin = lateMinMatch[1];
                    } else {
                        // Fallback (search by line keyword)
                        const lateLine = text.split("\n").find(l => l.toLowerCase().includes("late"));
                        if (lateLine) {
                            const v = lateLine.match(/([0-9]+(\.[0-9]+)?)/);
                            if (v) lateMin = v[1];
                        }
                    }

                    // OT 18h-22h (x1.5) 
                    let otHours15 = "";
                    const otRegex = /18h[\s-]?22h\s*([0-9]+(\.[0-9]+)?)/i;
                    const ot15Match = text.match(otRegex);
                    if (ot15Match) {
                        otHours15 = ot15Match[1];
                    } else {
                        // Less robust fallback: grab after "18h-22h"
                        const i = text.indexOf("18h-22h");
                        if (i > -1) {
                            const substr = text.substring(i, i+20); // right after
                            const v = substr.match(/([0-9]+(\.[0-9]+)?)/);
                            if (v) otHours15 = v[1];
                        }
                    }

                    // OT 22h-06h (x2.0) and Day-Off
                    let otHours20 = "";
                    const ot22hMatch = text.match(/22h[\s-]?06h\s*([0-9]+(\.[0-9]+)?)/i);
                    let otDayOffMatch = text.match(/Day[\s-]?Off\s*([0-9]+(\.[0-9]+)?)/i);
                    let ot20Sum = 0;
                    if (ot22hMatch) ot20Sum += parseFloat(ot22hMatch[1]);
                    if (otDayOffMatch) ot20Sum += parseFloat(otDayOffMatch[1]);
                    if (ot20Sum) otHours20 = ot20Sum.toString();

                    // Fill parsed data
                    let foundData = {};
                    let debugMsg = "";

                    if (rate) { foundData.rate = rate; debugMsg += `- Rate: ${rate}\n`; }
                    if (workDays) { foundData.workDays = workDays; debugMsg += `- WorkDays: ${workDays}\n`; }
                    if (lateMin) { foundData.lateMin = lateMin; debugMsg += `- LateMin: ${lateMin}\n`; }
                    if (otHours15) { foundData.otHours15 = otHours15; debugMsg += `- OT 18-22h: ${otHours15}\n`; }
                    if (otHours20) { foundData.otHours20 = otHours20; debugMsg += `- OT 22h-06h + DayOff: ${otHours20}\n`; }

                    if (Object.keys(foundData).length > 0) {
                        setData(prev => ({ ...prev, ...foundData }));
                        alert(`✅ Đã quét thành công!\n\n${debugMsg}`);
                    } else {
                        alert(`⚠️ Không tìm thấy từ khóa chính xác (Rate, OT...).\n\nVăn bản đọc được: "${text.substring(0, 100)}..."\n\nBạn vui lòng nhập tay nhé!`);
                    }

                    await worker.terminate();
                } catch (err) {
                    console.error(err);
                    alert("❌ Lỗi khi đọc ảnh: " + err.message);
                }
                setIsScanning(false);
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-6xl mx-auto">
                    <header className="mb-6 text-center md:text-left flex flex-col md:flex-row justify-between items-center">
                        <div>
                            <h1 className="text-3xl font-bold text-blue-900 flex items-center gap-2">
                                <i data-lucide="file-check" className="w-8 h-8"></i>
                                Tính Lương NET
                            </h1>
                            <p className="text-emerald-600 font-medium mt-1">✓ Đã cấu hình theo Hợp đồng Magenest</p>
                        </div>
                        <div className="flex gap-2 mt-4 md:mt-0">
                            <div className="relative">
                                <input 
                                    type="file" 
                                    ref={fileInputRef}
                                    onChange={handleImageUpload}
                                    accept="image/*"
                                    className="hidden"
                                />
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    disabled={isScanning}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg shadow-md font-medium transition flex items-center gap-2 disabled:opacity-50"
                                >
                                    {isScanning ? 'Đang đọc...' : 'Scan Ảnh Mới'}
                                </button>
                            </div>

                            <button 
                                onClick={loadStandardData}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg shadow-md font-medium transition flex items-center gap-2"
                            >
                                Reset Chuẩn
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* INPUT SECTION */}
                        <div className="lg:col-span-7 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            {/* Contract Setup */}
                            <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-6">
                                <h3 className="text-sm font-bold text-indigo-800 uppercase tracking-wide mb-3 flex items-center gap-2">
                                    Cấu phần Lương (Theo Hợp Đồng)
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="input-group">
                                        <label>Lương cứng <span className="tag-taxable">Chịu thuế</span></label>
                                        <input type="number" name="baseSalary" value={data.baseSalary} onChange={handleInputChange} className="font-semibold text-indigo-900" placeholder="0" />
                                    </div>
                                    <div className="input-group">
                                        <label>Thưởng chất lượng <span className="tag-taxable">Chịu thuế</span></label>
                                        <input type="number" name="qualityBonus" value={data.qualityBonus} onChange={handleInputChange} placeholder="0"/>
                                    </div>
                                    <div className="input-group">
                                        <label>Hỗ trợ ăn trưa <span className="tag-tax-exempt">Miễn thuế</span></label>
                                        <input type="number" name="lunchAllowance" value={data.lunchAllowance} onChange={handleInputChange} placeholder="0"/>
                                    </div>
                                    <div className="input-group">
                                        <label>Lương đóng BHXH (Fix)</label>
                                        <input type="number" name="insuranceBase" value={data.insuranceBase} onChange={handleInputChange} className="text-gray-500 bg-gray-100" placeholder="0"/>
                                    </div>
                                </div>
                            </div>

                            {/* Timekeeping Data */}
                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3">Dữ liệu chấm công</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="input-group">
                                    <label>Ngày công thực (Rate)</label>
                                    <input type="number" name="rate" value={data.rate} onChange={handleInputChange} className="border-emerald-200 focus:border-emerald-500" placeholder="0"/>
                                </div>
                                <div className="input-group">
                                    <label>Công chuẩn (Ngày)</label>
                                    <input type="number" name="workDays" value={data.workDays} onChange={handleInputChange} placeholder="0"/>
                                </div>
                                <div className="input-group">
                                    <label className="text-red-600">Phút đi muộn</label>
                                    <input type="number" name="lateMin" value={data.lateMin} onChange={handleInputChange} className="text-red-600" placeholder="0"/>
                                </div>
                            </div>

                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3 text-orange-600">OT & Thưởng khác</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-orange-50 p-4 rounded-lg border border-orange-100 mb-6">
                                <div className="input-group">
                                    <label>OT 18h-22h (x1.5)</label>
                                    <input type="number" name="otHours15" value={data.otHours15} onChange={handleInputChange} placeholder="0"/>
                                </div>
                                <div className="input-group">
                                    <label>OT Đêm/Cuối tuần (x2.0)</label>
                                    <input type="number" name="otHours20" value={data.otHours20} onChange={handleInputChange} placeholder="0"/>
                                </div>
                                <div className="input-group md:col-span-2 mt-2">
                                    <label>Thưởng Dự án (Nếu có)</label>
                                    <input type="number" name="projBonus" value={data.projBonus} onChange={handleInputChange} placeholder="0"/>
                                </div>
                            </div>
                            {/* Settings */}
                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3">Thiết lập khác</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <div className="input-group">
                                    <label>Số giờ/ngày</label>
                                    <input type="number" name="hoursPerDay" value={data.hoursPerDay} onChange={handleInputChange} placeholder="8"/>
                                </div>
                                <div className="input-group">
                                    <label>Tỷ lệ đóng BHXH (%)</label>
                                    <input type="number" name="insuranceRate" value={data.insuranceRate} onChange={handleInputChange} placeholder="0"/>
                                </div>
                                <div className="input-group md:col-span-2">
                                    <label>Giảm trừ bản thân</label>
                                    <input type="number" name="personalDeduction" value={data.personalDeduction} onChange={handleInputChange} placeholder="0"/>
                                </div>
                            </div>
                        </div>

                        {/* RESULT SECTION */}
                        <div className="lg:col-span-5">
                            <div className="bg-white p-6 rounded-xl shadow-lg border border-indigo-100 sticky top-4">
                                <div className="text-center mb-6">
                                    <h2 className="text-xl font-bold text-gray-800">PHIẾU LƯƠNG CHI TIẾT</h2>
                                    <p className="text-xs text-gray-400">Tháng 11/2025</p>
                                </div>

                                <div className="space-y-1 text-sm">
                                    {/* Income Group */}
                                    <div className="mb-4">
                                        <p className="text-xs font-bold text-gray-400 uppercase mb-2">1. Thu Nhập (Theo Rate {data.rate}/{data.workDays})</p>
                                        <div className="receipt-row">
                                            <span className="receipt-label">Lương cứng</span>
                                            <span className="receipt-value">{formatCurrency(results.actualBaseSalary)}</span>
                                        </div>
                                        <div className="receipt-row">
                                            <span className="receipt-label">Thưởng chất lượng</span>
                                            <span className="receipt-value">{formatCurrency(results.actualQualityBonus)}</span>
                                        </div>
                                        <div className="receipt-row">
                                            <span className="receipt-label">Phụ cấp ăn trưa</span>
                                            <span className="receipt-value text-green-600">{formatCurrency(results.actualLunch)}</span>
                                        </div>
                                        <div className="receipt-row">
                                            <span className="receipt-label">Lương OT (Tổng)</span>
                                            <span className="receipt-value text-blue-600">{formatCurrency(results.totalOtSalary)}</span>
                                        </div>
                                        {parseFloat(data.projBonus) > 0 && <div className="receipt-row">
                                            <span className="receipt-label">Thưởng dự án</span>
                                            <span className="receipt-value text-blue-600">{formatCurrency(data.projBonus)}</span>
                                        </div>}
                                    </div>

                                    {/* Tax Calc */}
                                    <div className="mb-4 bg-gray-50 p-3 rounded border border-gray-200">
                                        <p className="text-xs font-bold text-gray-400 uppercase mb-2">2. Tính Thuế TNCN</p>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span>Thu nhập chịu thuế:</span>
                                            <span className="font-semibold">{formatCurrency(results.taxableIncome)}</span>
                                        </div>
                                        <div className="flex justify-between text-xs mb-1 text-gray-500">
                                            <span>(Đã trừ ăn trưa: {formatCurrency(results.actualLunch)})</span>
                                        </div>
                                        <div className="flex justify-between text-xs mb-1 text-red-500">
                                            <span>- Giảm trừ (BH+Bản thân):</span>
                                            <span>{formatCurrency(results.taxDeductions)}</span>
                                        </div>
                                        <div className="border-t border-gray-300 my-1"></div>
                                        <div className="flex justify-between font-bold text-gray-800">
                                            <span>Thu nhập tính thuế:</span>
                                            <span>{formatCurrency(results.taxAssessmentIncome)}</span>
                                        </div>
                                        <div className="flex justify-between text-red-600 font-bold mt-1">
                                            <span>Thuế phải đóng:</span>
                                            <span>{formatCurrency(results.tax)}</span>
                                        </div>
                                    </div>

                                    {/* Deductions & Final */}
                                    <div className="mb-4">
                                        <p className="text-xs font-bold text-gray-400 uppercase mb-2">3. Các khoản trừ</p>
                                        <div className="receipt-row">
                                            <span className="receipt-label">BHXH (Tỷ lệ: {data.insuranceRate}% x {formatCurrency(data.insuranceBase)})</span>
                                            <span className="receipt-value text-red-500">-{formatCurrency(results.insuranceDeduction)}</span>
                                        </div>
                                        <div className="receipt-row">
                                            <span className="receipt-label">Phạt đi muộn ({data.lateMin}p)</span>
                                            <span className="receipt-value text-red-500">-{formatCurrency(results.latePenalty)}</span>
                                        </div>
                                        <div className="receipt-row">
                                            <span className="receipt-label">Thuế TNCN</span>
                                            <span className="receipt-value text-red-500">-{formatCurrency(results.tax)}</span>
                                        </div>
                                    </div>

                                    <div className="mt-6 pt-4 border-t-2 border-dashed border-gray-300">
                                        <div className="flex justify-between items-end">
                                            <span className="text-gray-500 font-bold text-sm uppercase">THỰC NHẬN (NET)</span>
                                            <span className="text-3xl font-bold text-indigo-700">{formatCurrency(results.netIncome)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
